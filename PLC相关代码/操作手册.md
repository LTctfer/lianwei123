# PLC到算能AI-BOX数据采集系统操作手册

## 目录
1. [系统概述](#系统概述)
2. [安装部署](#安装部署)
3. [配置说明](#配置说明)
4. [操作指南](#操作指南)
5. [监控管理](#监控管理)
6. [故障排除](#故障排除)
7. [维护保养](#维护保养)
8. [API接口](#api接口)

## 系统概述

### 系统架构
PLC到AI-BOX数据采集系统采用模块化设计，主要包含以下组件：

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   PLC设备   │───▶│  数据采集器  │───▶│  数据处理器  │───▶│ AI-BOX上传器│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
   现场传感器           实时采集           智能处理           云端存储
```

### 主要功能
- **实时数据采集**: 支持多种工业协议，实时采集PLC数据
- **智能数据处理**: 数据清洗、滤波、降采样、特征提取
- **频谱分析**: FFT计算，振动频谱分析
- **公式计算**: 自定义计算公式，衍生参数计算
- **云端上传**: 自动上传至算能AI-BOX平台
- **本地存储**: SQLite数据库本地备份
- **Web监控**: 实时监控界面，数据可视化

## 安装部署

### 系统要求
- **操作系统**: Windows 10/11, Linux (Ubuntu 18.04+), CentOS 7+
- **Python版本**: 3.8或更高版本
- **内存**: 最少2GB，推荐4GB+
- **存储空间**: 最少10GB可用空间
- **网络**: 稳定的以太网连接

### 自动安装
1. **下载安装包**
   ```bash
   git clone https://github.com/your-repo/plc-aibox-system.git
   cd plc-aibox-system
   ```

2. **运行安装脚本**
   ```bash
   python install.py
   ```

3. **按照提示完成安装**
   - 自动创建虚拟环境
   - 安装所需依赖包
   - 创建配置文件
   - 设置系统服务

### 手动安装
1. **创建虚拟环境**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux
   # 或
   venv\Scripts\activate     # Windows
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **配置系统**
   ```bash
   cp config_template.py config.py
   # 编辑config.py文件
   ```

## 配置说明

### PLC配置
编辑 `config.py` 文件中的 `PLC_CONFIG` 部分：

```python
PLC_CONFIG = {
    'ip_address': '192.168.1.10',    # PLC IP地址
    'port': 502,                     # 通信端口
    'device_id': 'PLC_001',          # 设备ID
    'protocol': 'modbus_tcp',        # 协议类型
    'scan_rate': 1000,               # 扫描周期(ms)
    'parameters': [                  # 数据点配置
        {
            'name': 'vibration_x',
            'address': 'DB1.DBD0',
            'type': 'REAL',
            'unit': 'mm/s',
            'min_value': -100.0,
            'max_value': 100.0
        },
        # 更多参数...
    ]
}
```

### AI-BOX配置
配置AI-BOX连接参数：

```python
AIBOX_CONFIG = AIBoxConfig(
    ip_address="192.168.1.100",      # AI-BOX IP
    port=8080,                       # API端口
    api_endpoint="/api/data/upload", # 上传接口
    auth_token="your_token_here",    # 认证令牌
    batch_size=50,                   # 批量大小
    upload_interval=30               # 上传间隔(秒)
)
```

### 数据处理配置
配置数据处理参数：

```python
PROCESSING_CONFIG = {
    'buffer_size': 1000,             # 缓冲区大小
    'enable_fft': True,              # 启用FFT
    'fft_window_size': 128,          # FFT窗口
    'filter_config': {               # 滤波器配置
        'vibration': {
            'type': 'bandpass',
            'low_freq': 0.1,
            'high_freq': 0.4
        }
    }
}
```

## 操作指南

### 启动系统

#### 方式1: 使用启动脚本
**Windows:**
```cmd
双击 start.bat
```

**Linux:**
```bash
./start.sh
```

#### 方式2: 命令行启动
```bash
cd plc-aibox-system
source venv/bin/activate  # Linux
python plc_to_aibox_system.py
```

#### 方式3: 系统服务启动 (Linux)
```bash
sudo systemctl start plc-aibox
sudo systemctl enable plc-aibox  # 开机自启
```

### 停止系统
- **Ctrl+C**: 在命令行中停止
- **系统服务**: `sudo systemctl stop plc-aibox`
- **Web界面**: 通过监控界面停止

### 查看系统状态
```bash
# 查看服务状态
sudo systemctl status plc-aibox

# 查看日志
tail -f plc_aibox_system.log

# 查看进程
ps aux | grep plc_to_aibox
```

## 监控管理

### Web监控界面
1. **访问地址**: http://localhost:8888
2. **主要功能**:
   - 实时数据监控
   - 系统状态查看
   - 数据质量统计
   - FFT频谱分析
   - 历史数据查询

### 启动Web监控
```bash
python web_monitor.py
```

### 监控指标
- **系统运行状态**: 正常/异常
- **设备连接状态**: 在线/离线
- **数据采集率**: 成功采集的数据比例
- **数据质量分数**: 0-1之间，越高越好
- **上传成功率**: 成功上传到AI-BOX的比例

### 报警设置
系统支持以下报警类型：
- **设备离线报警**: PLC连接中断
- **数据质量报警**: 质量分数低于阈值
- **上传失败报警**: 连续上传失败
- **磁盘空间报警**: 存储空间不足

## 故障排除

### 常见问题

#### 1. PLC连接失败
**现象**: 日志显示连接超时或拒绝连接

**排查步骤**:
1. 检查网络连通性: `ping PLC_IP`
2. 检查端口是否开放: `telnet PLC_IP PORT`
3. 验证PLC配置和协议设置
4. 检查防火墙设置

**解决方案**:
```python
# 调整连接参数
PLC_CONFIG = {
    'timeout': 10,        # 增加超时时间
    'retry_count': 5,     # 增加重试次数
    'retry_delay': 3      # 增加重试间隔
}
```

#### 2. 数据上传失败
**现象**: 数据无法上传到AI-BOX

**排查步骤**:
1. 检查AI-BOX网络连接
2. 验证API接口和认证令牌
3. 检查数据格式是否正确
4. 查看AI-BOX服务器日志

**解决方案**:
```python
# 调整上传参数
AIBOX_CONFIG = AIBoxConfig(
    timeout=60,           # 增加超时时间
    max_retries=5,        # 增加重试次数
    batch_size=20         # 减少批量大小
)
```

#### 3. 内存使用过高
**现象**: 系统内存占用持续增长

**排查步骤**:
1. 检查缓冲区大小设置
2. 查看数据清理机制
3. 监控内存使用情况

**解决方案**:
```python
# 优化内存使用
PROCESSING_CONFIG = {
    'buffer_size': 500,   # 减少缓冲区
    'cleanup_interval': 1800,  # 定期清理
}

# 启用数据清理
def periodic_cleanup():
    cleanup_old_data(days_to_keep=7)
```

#### 4. FFT计算失败
**现象**: 频谱分析功能异常

**排查步骤**:
1. 检查输入数据长度
2. 验证采样频率设置
3. 查看数据连续性

**解决方案**:
```python
# 调整FFT参数
PROCESSING_CONFIG = {
    'fft_window_size': 64,    # 减少窗口大小
    'min_samples': 32,        # 最少样本数
}
```

### 日志分析
系统日志位置: `plc_aibox_system.log`

**重要日志关键词**:
- `ERROR`: 错误信息
- `WARNING`: 警告信息
- `连接失败`: PLC连接问题
- `上传失败`: AI-BOX上传问题
- `数据质量`: 数据质量问题

**日志查看命令**:
```bash
# 查看最新日志
tail -f plc_aibox_system.log

# 搜索错误日志
grep "ERROR" plc_aibox_system.log

# 查看特定时间段日志
grep "2024-01-01" plc_aibox_system.log
```

## 维护保养

### 定期维护任务

#### 每日检查
- [ ] 检查系统运行状态
- [ ] 查看数据采集率
- [ ] 检查磁盘空间使用
- [ ] 查看错误日志

#### 每周维护
- [ ] 清理过期日志文件
- [ ] 备份配置文件
- [ ] 检查数据库大小
- [ ] 更新系统状态报告

#### 每月维护
- [ ] 清理过期数据
- [ ] 检查系统性能
- [ ] 更新系统文档
- [ ] 备份重要数据

### 数据备份
```bash
# 备份数据库
cp plc_data.db backup/plc_data_$(date +%Y%m%d).db

# 备份配置文件
cp config.py backup/config_$(date +%Y%m%d).py

# 备份日志文件
tar -czf backup/logs_$(date +%Y%m%d).tar.gz *.log
```

### 性能优化
1. **数据库优化**
   ```sql
   -- 重建索引
   REINDEX;
   
   -- 清理数据库
   VACUUM;
   ```

2. **系统优化**
   ```bash
   # 清理临时文件
   rm -rf temp/*
   
   # 优化Python缓存
   find . -name "*.pyc" -delete
   find . -name "__pycache__" -type d -exec rm -rf {} +
   ```

## API接口

### 系统状态API
```http
GET /api/status
```

**响应示例**:
```json
{
    "status": "running",
    "uptime": 3600,
    "devices": 2,
    "data_rate": 0.985,
    "upload_rate": 0.992
}
```

### 数据查询API
```http
GET /api/data?device=PLC_001&start=2024-01-01&end=2024-01-02
```

**响应示例**:
```json
{
    "device_id": "PLC_001",
    "data_count": 1440,
    "data": [
        {
            "timestamp": "2024-01-01T00:00:00",
            "vibration_x": 1.23,
            "temperature": 25.6
        }
    ]
}
```

### 配置管理API
```http
POST /api/config
Content-Type: application/json

{
    "scan_rate": 2000,
    "upload_interval": 60
}
```

---

**技术支持联系方式**:
- 邮箱: support@example.com
- 电话: 400-xxx-xxxx
- 在线文档: https://docs.example.com
